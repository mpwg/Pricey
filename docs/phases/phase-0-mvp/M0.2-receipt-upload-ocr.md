# M0.2: Receipt Upload & OCR Processing

**Duration**: Week 2 (7-10 days)  
**Priority**: P0 (Critical)  
**Story Points**: 21

## ðŸ“‹ User Story

**As a** user  
**I want to** upload a receipt photo and have it automatically processed  
**So that** I can digitize my receipts without manual data entry

## ðŸŽ¯ Objectives

Implement receipt upload functionality with OCR processing using Tesseract.js, including image storage, text extraction, and basic store/item detection.

## âœ… Acceptance Criteria

- [ ] Users can upload JPG/PNG images up to 10MB
- [ ] Images are stored securely in S3/MinIO
- [ ] OCR processes receipts in under 30 seconds
- [ ] System extracts at least 70% of items accurately
- [ ] Store name is detected from receipt
- [ ] Individual items with prices are extracted
- [ ] Receipt data is stored in database with proper relationships
- [ ] Processing status is returned to user
- [ ] Failed uploads return clear error messages

## ðŸ”§ API Endpoints

### 1. Upload Receipt

```typescript
POST /api/v1/receipts/upload
Content-Type: multipart/form-data

Request:
{
  image: File,
  metadata?: {
    date?: string,
    store?: string
  }
}

Response: 201 Created
{
  id: "uuid",
  status: "processing",
  uploadedAt: "2025-11-15T10:30:00Z",
  processingStartedAt: "2025-11-15T10:30:01Z",
  imageUrl: "https://storage.../receipt.jpg"
}
```

### 2. Get Receipt Status

```typescript
GET /api/v1/receipts/:id/status

Response: 200 OK
{
  id: "uuid",
  status: "completed",
  progress: 100,
  ocrResult: {
    storeName: "Walmart",
    date: "2025-11-14T00:00:00Z",
    items: [
      {
        name: "Milk 2%",
        price: 3.99,
        quantity: 1,
        confidence: 0.92
      }
    ],
    total: 45.67
  },
  processingTime: 12500
}
```

### 3. Get Receipt Details

```typescript
GET /api/v1/receipts/:id

Response: 200 OK
{
  id: "uuid",
  imageUrl: "https://storage.../receipt.jpg",
  storeName: "Walmart",
  purchaseDate: "2025-11-14T00:00:00Z",
  totalAmount: 45.67,
  status: "completed",
  ocrProvider: "tesseract",
  ocrConfidence: 0.85,
  rawOcrText: "WALMART\nSupercenter #1234...",
  processingTime: 12500,
  items: [
    {
      id: "uuid",
      name: "Milk 2%",
      price: 3.99,
      quantity: 1,
      category: "dairy",
      confidence: 0.92
    }
  ],
  createdAt: "2025-11-15T10:30:00Z",
  updatedAt: "2025-11-15T10:30:15Z"
}
```

## ðŸ“ Tasks

### 1. File Upload Service

- [ ] Create upload endpoint in API Gateway
  - [ ] `POST /api/v1/receipts/upload`
  - [ ] Use `@fastify/multipart` plugin
- [ ] Implement file validation
  - [ ] Check file type (jpg, jpeg, png only)
  - [ ] Check file size (max 10MB)
  - [ ] Check image dimensions (min 500x500px)
  - [ ] Validate file is actually an image
- [ ] Generate unique file names
  - [ ] Use UUID + original extension
  - [ ] Add timestamp prefix for organization
- [ ] Configure S3/MinIO client
  - [ ] Install AWS SDK or MinIO client
  - [ ] Configure credentials from env
  - [ ] Create bucket if not exists
- [ ] Upload files to storage
  - [ ] Set proper content type
  - [ ] Set appropriate permissions
  - [ ] Generate signed URLs for access
- [ ] Add upload progress tracking (optional)
- [ ] Implement cleanup for failed uploads
  - [ ] Delete file if OCR fails
  - [ ] Retry logic for transient failures

**Files to Create:**

- `apps/api-gateway/src/routes/receipts/upload.ts`
- `apps/api-gateway/src/services/storage.service.ts`
- `apps/api-gateway/src/utils/file-validation.ts`

**Example Upload Handler:**

```typescript
import { FastifyInstance } from "fastify";
import { storageService } from "../../services/storage.service";
import { validateImage } from "../../utils/file-validation";
import { queueOCRJob } from "../../services/queue.service";
import { db } from "@pricy/database";

export async function uploadRoute(app: FastifyInstance) {
  app.post("/upload", async (request, reply) => {
    const data = await request.file();

    if (!data) {
      return reply.code(400).send({ error: "No file provided" });
    }

    // Validate file
    await validateImage(data);

    // Upload to storage
    const imageUrl = await storageService.upload(data);

    // Create receipt record
    const receipt = await db.receipt.create({
      data: {
        imageUrl,
        status: "PENDING",
      },
    });

    // Queue OCR job
    await queueOCRJob(receipt.id, imageUrl);

    return reply.code(201).send({
      id: receipt.id,
      status: "processing",
      uploadedAt: receipt.createdAt,
      imageUrl,
    });
  });
}
```

### 2. OCR Service Setup

- [ ] Create `apps/ocr-service` workspace
  - [ ] Initialize Node.js project
  - [ ] Configure TypeScript
  - [ ] Add package.json scripts
- [ ] Install Tesseract.js
  - [ ] `npm install tesseract.js`
  - [ ] Download language data (eng)
- [ ] Create OCR service structure
  - [ ] `src/index.ts` - Entry point
  - [ ] `src/ocr/tesseract.ts` - Tesseract wrapper
  - [ ] `src/processors/receipt-processor.ts` - Receipt parsing
  - [ ] `src/parsers/store-detector.ts` - Store detection
  - [ ] `src/parsers/item-extractor.ts` - Item extraction
- [ ] Implement image preprocessing
  - [ ] Convert to grayscale
  - [ ] Adjust contrast
  - [ ] Deskew (straighten) image
  - [ ] Remove noise
  - [ ] Resize if too large
- [ ] Configure Tesseract options
  - [ ] PSM mode (Page Segmentation Mode)
  - [ ] Whitelist characters
  - [ ] Language settings
- [ ] Implement timeout handling (30s max)
- [ ] Add retry logic for transient failures
- [ ] Log processing metrics
  - [ ] Processing time
  - [ ] Confidence scores
  - [ ] Success/failure rates

**Files to Create:**

- `apps/ocr-service/package.json`
- `apps/ocr-service/src/index.ts`
- `apps/ocr-service/src/ocr/tesseract.ts`
- `apps/ocr-service/src/processors/receipt-processor.ts`
- `apps/ocr-service/src/parsers/store-detector.ts`
- `apps/ocr-service/src/parsers/item-extractor.ts`
- `apps/ocr-service/src/utils/image-preprocessing.ts`

**Example OCR Implementation:**

```typescript
import Tesseract from "tesseract.js";
import sharp from "sharp";

export class TesseractOCR {
  async processReceipt(imageBuffer: Buffer): Promise<string> {
    // Preprocess image
    const preprocessed = await this.preprocessImage(imageBuffer);

    // Run OCR
    const { data } = await Tesseract.recognize(preprocessed, "eng", {
      logger: (m) => console.log(m),
      tessedit_char_whitelist:
        "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz$.,/:-() ",
      tessedit_pageseg_mode: Tesseract.PSM.AUTO,
    });

    return data.text;
  }

  private async preprocessImage(imageBuffer: Buffer): Promise<Buffer> {
    return sharp(imageBuffer)
      .greyscale()
      .normalize()
      .sharpen()
      .resize({ width: 2000, withoutEnlargement: true })
      .toBuffer();
  }
}
```

### 3. Receipt Text Parsing

**Store Name Detection:**

- [ ] Create store patterns database
  - [ ] Add 20+ major stores
  - [ ] Include name variations
  - [ ] Add regex patterns
- [ ] Implement fuzzy matching
  - [ ] Use Levenshtein distance
  - [ ] Handle typos and OCR errors
- [ ] Search first 10 lines for store name
- [ ] Extract and normalize store name

**Date Extraction:**

- [ ] Create date format patterns
  - [ ] MM/DD/YYYY
  - [ ] DD/MM/YYYY
  - [ ] YYYY-MM-DD
  - [ ] Month DD, YYYY
- [ ] Search for date indicators
  - [ ] "DATE:", "Date:", "Purchased:"
- [ ] Validate extracted dates
  - [ ] Must be in the past
  - [ ] Not more than 1 year old
- [ ] Fallback to upload date if not found

**Item Extraction:**

- [ ] Detect item lines with patterns
  - [ ] Item name followed by price
  - [ ] Handle multi-line items
  - [ ] Detect quantities (2 @ $3.99)
- [ ] Extract item components
  - [ ] Name (cleaned)
  - [ ] Price (parsed to decimal)
  - [ ] Quantity (default to 1)
- [ ] Calculate confidence scores
  - [ ] Based on pattern match
  - [ ] Based on price validity
- [ ] Handle edge cases
  - [ ] Crossed out items
  - [ ] Discounts and coupons
  - [ ] Tax lines

**Total Amount Extraction:**

- [ ] Search for total indicators
  - [ ] "TOTAL", "Total:", "AMOUNT DUE"
  - [ ] "BALANCE", "Grand Total"
- [ ] Extract total amount
- [ ] Validate against sum of items
  - [ ] Allow 5% variance (tax/discounts)
- [ ] Store both extracted and calculated totals

**Files to Create:**

- `apps/ocr-service/src/parsers/date-parser.ts`
- `apps/ocr-service/src/parsers/item-parser.ts`
- `apps/ocr-service/src/parsers/total-parser.ts`
- `apps/ocr-service/src/utils/fuzzy-match.ts`

**Example Store Detection:**

```typescript
const storePatterns = [
  { name: "Walmart", patterns: [/walmart/i, /wal\s*mart/i] },
  { name: "Target", patterns: [/target/i, /target\s*corp/i] },
  { name: "Costco", patterns: [/costco/i, /costco\s*wholesale/i] },
  { name: "Kroger", patterns: [/kroger/i, /kroger\s*co/i] },
  // ... more stores
];

export function detectStore(text: string): string | null {
  const firstLines = text.split("\n").slice(0, 10).join("\n");

  for (const store of storePatterns) {
    for (const pattern of store.patterns) {
      if (pattern.test(firstLines)) {
        return store.name;
      }
    }
  }

  return null;
}
```

### 4. Store Detection Database

- [ ] Seed stores in database
  - [ ] Add 20+ major US stores
  - [ ] Include store aliases
  - [ ] Add receipt format hints
- [ ] Create store matching service
- [ ] Add store logo URLs (optional)

**Stores to Add:**

- Grocery: Walmart, Target, Kroger, Safeway, Whole Foods, Trader Joe's
- Pharmacy: CVS, Walgreens, Rite Aid
- Home: Home Depot, Lowe's, Bed Bath & Beyond
- Electronics: Best Buy, Apple Store
- Department: Macy's, Nordstrom, Kohl's
- Warehouse: Costco, Sam's Club, BJ's
- Other: Amazon, 7-Eleven, Starbucks

**Seed Script:**

```typescript
const stores = [
  {
    name: "Walmart",
    aliases: ["Wal-Mart", "Walmart Supercenter", "Walmart Neighborhood Market"],
    logoUrl: "https://logo.clearbit.com/walmart.com",
  },
  {
    name: "Target",
    aliases: ["Target Corporation", "SuperTarget"],
    logoUrl: "https://logo.clearbit.com/target.com",
  },
  // ... more stores
];

await db.store.createMany({ data: stores });
```

### 5. Background Job Processing

- [ ] Install BullMQ
  - [ ] `npm install bullmq`
  - [ ] Configure Redis connection
- [ ] Create OCR job queue
  - [ ] Define job schema
  - [ ] Set job options (timeout, retries)
- [ ] Implement job processor
  - [ ] Download image from S3
  - [ ] Run OCR
  - [ ] Parse results
  - [ ] Update database
- [ ] Add job status tracking
  - [ ] Update receipt status in DB
  - [ ] Store processing metrics
- [ ] Implement retry logic
  - [ ] 3 attempts with exponential backoff
  - [ ] Mark as failed after retries
- [ ] Create job completion handler
  - [ ] Update receipt with results
  - [ ] Send webhook (optional)
- [ ] Add Bull Board for monitoring
  - [ ] Install `@bull-board/api` and `@bull-board/fastify`
  - [ ] Mount dashboard at `/admin/queues`

**Files to Create:**

- `apps/ocr-service/src/queue/ocr-queue.ts`
- `apps/ocr-service/src/queue/processors/ocr-processor.ts`
- `apps/api-gateway/src/services/queue.service.ts`

**Example Queue Setup:**

```typescript
import { Queue, Worker } from "bullmq";
import Redis from "ioredis";

const connection = new Redis(process.env.REDIS_URL);

export const ocrQueue = new Queue("ocr-processing", { connection });

export const ocrWorker = new Worker(
  "ocr-processing",
  async (job) => {
    const { receiptId, imageUrl } = job.data;

    // Download image
    const imageBuffer = await downloadImage(imageUrl);

    // Run OCR
    const ocrText = await tesseractOCR.processReceipt(imageBuffer);

    // Parse receipt
    const receipt = await receiptProcessor.parse(ocrText);

    // Update database
    await db.receipt.update({
      where: { id: receiptId },
      data: {
        status: "COMPLETED",
        storeName: receipt.storeName,
        purchaseDate: receipt.date,
        totalAmount: receipt.total,
        rawOcrText: ocrText,
        items: {
          createMany: {
            data: receipt.items,
          },
        },
      },
    });
  },
  {
    connection,
    concurrency: 5,
    limiter: {
      max: 10,
      duration: 60000, // 10 jobs per minute
    },
  }
);
```

### 6. Error Handling & Validation

- [ ] Validate file types
- [ ] Validate file size
- [ ] Validate image dimensions
- [ ] Handle OCR timeout errors
- [ ] Handle storage errors
- [ ] Handle database errors
- [ ] Return user-friendly error messages
- [ ] Log errors to Sentry (if configured)

**Error Codes:**

- `FILE_TOO_LARGE` - File exceeds 10MB
- `INVALID_FILE_TYPE` - Not a JPG/PNG
- `INVALID_IMAGE` - Corrupted or invalid image
- `OCR_TIMEOUT` - Processing took too long
- `OCR_FAILED` - Could not extract text
- `STORAGE_ERROR` - Failed to upload
- `DATABASE_ERROR` - Failed to save

### 7. Testing

- [ ] Unit tests for file validation
- [ ] Unit tests for OCR text extraction
- [ ] Unit tests for store detection
- [ ] Unit tests for item parsing
- [ ] Unit tests for date parsing
- [ ] Unit tests for total extraction
- [ ] Integration tests for upload flow
- [ ] Create test receipt fixtures
  - [ ] Various stores (Walmart, Target, etc.)
  - [ ] Different quality levels
  - [ ] Edge cases (damaged, rotated, etc.)
- [ ] Test edge cases
  - [ ] Blurry receipts
  - [ ] Rotated receipts
  - [ ] Crumpled receipts
  - [ ] Faded receipts
- [ ] Load testing
  - [ ] 10 concurrent uploads
  - [ ] Measure processing time
  - [ ] Check queue performance

**Test Fixtures Location:**

- `apps/ocr-service/test/fixtures/receipts/`
  - `walmart-good-quality.jpg`
  - `target-medium-quality.jpg`
  - `costco-poor-quality.jpg`
  - `rotated-receipt.jpg`
  - `damaged-receipt.jpg`

## ðŸ§ª Testing Checklist

### Manual Testing

- [ ] Upload clear receipt â†’ 70%+ accuracy
- [ ] Upload blurry receipt â†’ still processes
- [ ] Upload rotated receipt â†’ handles rotation
- [ ] Upload non-receipt image â†’ returns error
- [ ] Upload oversized file â†’ returns error
- [ ] Upload unsupported format â†’ returns error
- [ ] Check processing status endpoint
- [ ] Verify stored data in database
- [ ] Test various store receipts

### Automated Testing

- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] OCR accuracy test suite > 70% average
- [ ] Load test: 10 concurrent uploads succeed
- [ ] Processing time < 30s (p95)

### OCR Accuracy Testing

Test with 20+ real receipts:

- [ ] Store detection: 80%+ accuracy
- [ ] Date extraction: 70%+ accuracy
- [ ] Item extraction: 70%+ accuracy
- [ ] Total extraction: 80%+ accuracy
- [ ] Overall confidence: 70%+ average

## ðŸ“Š Success Metrics

- **OCR Accuracy**: â‰¥ 70% of items extracted correctly
- **Processing Time**: < 30 seconds (p95)
- **Success Rate**: > 95% for good quality images
- **Store Detection**: â‰¥ 80% accuracy for major stores
- **Item Extraction**: â‰¥ 70% of line items captured
- **Error Rate**: < 5% of uploads fail

## ðŸ”— Dependencies

- **Depends on**: M0.1 (Infrastructure Setup)
- **Blocks**: M0.3 (Basic Receipt List UI)

## âš ï¸ Known Technical Debt

1. **Single OCR Provider**: Only Tesseract.js (no cloud fallback)
2. **Limited Store Templates**: Only ~20 stores initially
3. **No Manual Correction**: Users can't edit OCR results
4. **Basic Image Processing**: Minimal preprocessing
5. **No User Feedback Loop**: Can't learn from corrections
6. **No Batch Processing**: One receipt at a time

_These will be addressed in Phase 1 (Beta)_

## ðŸ“š Reference Documentation

- [Tesseract.js Documentation](https://tesseract.projectnaptha.com/)
- [BullMQ Documentation](https://docs.bullmq.io/)
- [Sharp (Image Processing)](https://sharp.pixelplumbing.com/)
- [MinIO Client](https://min.io/docs/minio/linux/developers/javascript/minio-javascript.html)

## ðŸŽ¯ Definition of Done

- [ ] All tasks completed
- [ ] All acceptance criteria met
- [ ] OCR accuracy â‰¥ 70%
- [ ] All tests passing
- [ ] API documented
- [ ] Code reviewed
- [ ] Successfully processes 10 test receipts
