# M0.2: Receipt Upload & OCR Processing

**Duration**: Week 2 (7-10 days)  
**Priority**: P0 (Critical)  
**Story Points**: 21

## ðŸ“‹ User Story

**As a** user  
**I want to** upload a receipt photo and have it automatically processed  
**So that** I can digitize my receipts without manual data entry

## ðŸŽ¯ Objectives

Implement receipt upload functionality with OCR processing using Tesseract.js, including image storage, text extraction, and basic store/item detection.

## âœ… Acceptance Criteria

- [x] Users can upload JPG/PNG images up to 10MB
- [x] Images are stored securely in S3/MinIO
- [x] OCR processes receipts in under 30 seconds
- [x] System extracts at least 70% of items accurately
- [x] Store name is detected from receipt
- [x] Individual items with prices are extracted
- [x] Receipt data is stored in database with proper relationships
- [x] Processing status is returned to user
- [x] Failed uploads return clear error messages

## ðŸ”§ API Endpoints

### 1. Upload Receipt

```typescript
POST /api/v1/receipts/upload
Content-Type: multipart/form-data

Request:
{
  image: File,
  metadata?: {
    date?: string,
    store?: string
  }
}

Response: 201 Created
{
  id: "uuid",
  status: "processing",
  uploadedAt: "2025-11-15T10:30:00Z",
  processingStartedAt: "2025-11-15T10:30:01Z",
  imageUrl: "https://storage.../receipt.jpg"
}
```

### 2. Get Receipt Status

```typescript
GET /api/v1/receipts/:id/status

Response: 200 OK
{
  id: "uuid",
  status: "completed",
  progress: 100,
  ocrResult: {
    storeName: "Walmart",
    date: "2025-11-14T00:00:00Z",
    items: [
      {
        name: "Milk 2%",
        price: 3.99,
        quantity: 1,
        confidence: 0.92
      }
    ],
    total: 45.67
  },
  processingTime: 12500
}
```

### 3. Get Receipt Details

```typescript
GET /api/v1/receipts/:id

Response: 200 OK
{
  id: "uuid",
  imageUrl: "https://storage.../receipt.jpg",
  storeName: "Walmart",
  purchaseDate: "2025-11-14T00:00:00Z",
  totalAmount: 45.67,
  status: "completed",
  ocrProvider: "tesseract",
  ocrConfidence: 0.85,
  rawOcrText: "WALMART\nSupercenter #1234...",
  processingTime: 12500,
  items: [
    {
      id: "uuid",
      name: "Milk 2%",
      price: 3.99,
      quantity: 1,
      category: "dairy",
      confidence: 0.92
    }
  ],
  createdAt: "2025-11-15T10:30:00Z",
  updatedAt: "2025-11-15T10:30:15Z"
}
```

## ðŸ“ Tasks

### 1. File Upload Service

- [x] Create upload endpoint in API Gateway
  - [x] `POST /api/v1/receipts/upload`
  - [x] Use `@fastify/multipart` plugin
- [x] Implement file validation
  - [x] Check file type (jpg, jpeg, png only)
  - [x] Check file size (max 10MB)
  - [x] Check image dimensions (min 500x500px)
  - [x] Validate file is actually an image
- [x] Generate unique file names
  - [x] Use UUID + original extension
  - [x] Add timestamp prefix for organization
- [x] Configure S3/MinIO client
  - [x] Install AWS SDK or MinIO client
  - [x] Configure credentials from env
  - [x] Create bucket if not exists
- [x] Upload files to storage
  - [x] Set proper content type
  - [x] Set appropriate permissions
  - [x] Generate signed URLs for access
- [x] Add upload progress tracking (optional)
- [x] Implement cleanup for failed uploads
  - [x] Delete file if OCR fails
  - [x] Retry logic for transient failures

**Files to Create:**

- `apps/api-gateway/src/routes/receipts/upload.ts`
- `apps/api-gateway/src/services/storage.service.ts`
- `apps/api-gateway/src/utils/file-validation.ts`

**Example Upload Handler:**

```typescript
import { FastifyInstance } from 'fastify';
import { storageService } from '../../services/storage.service';
import { validateImage } from '../../utils/file-validation';
import { queueOCRJob } from '../../services/queue.service';
import { db } from '@pricey/database';

export async function uploadRoute(app: FastifyInstance) {
  app.post('/upload', async (request, reply) => {
    const data = await request.file();

    if (!data) {
      return reply.code(400).send({ error: 'No file provided' });
    }

    // Validate file
    await validateImage(data);

    // Upload to storage
    const imageUrl = await storageService.upload(data);

    // Create receipt record
    const receipt = await db.receipt.create({
      data: {
        imageUrl,
        status: 'PENDING',
      },
    });

    // Queue OCR job
    await queueOCRJob(receipt.id, imageUrl);

    return reply.code(201).send({
      id: receipt.id,
      status: 'processing',
      uploadedAt: receipt.createdAt,
      imageUrl,
    });
  });
}
```

### 2. OCR Service Setup

- [x] Create `apps/ocr-service` workspace
  - [x] Initialize Node.js project
  - [x] Configure TypeScript
  - [x] Add package.json scripts
- [x] Install Tesseract.js
  - [x] `npm install tesseract.js`
  - [x] Download language data (eng)
- [x] Create OCR service structure
  - [x] `src/index.ts` - Entry point
  - [x] `src/ocr/tesseract.ts` - Tesseract wrapper
  - [x] `src/processors/receipt-processor.ts` - Receipt parsing
  - [x] `src/parsers/store-detector.ts` - Store detection
  - [x] `src/parsers/item-extractor.ts` - Item extraction
- [x] Implement image preprocessing
  - [x] Convert to grayscale
  - [x] Adjust contrast
  - [x] Deskew (straighten) image
  - [x] Remove noise
  - [x] Resize if too large
- [x] Configure Tesseract options
  - [x] PSM mode (Page Segmentation Mode)
  - [x] Whitelist characters
  - [x] Language settings
- [x] Implement timeout handling (30s max)
- [x] Add retry logic for transient failures
- [x] Log processing metrics
  - [x] Processing time
  - [x] Confidence scores
  - [x] Success/failure rates

**Files to Create:**

- `apps/ocr-service/package.json`
- `apps/ocr-service/src/index.ts`
- `apps/ocr-service/src/ocr/tesseract.ts`
- `apps/ocr-service/src/processors/receipt-processor.ts`
- `apps/ocr-service/src/parsers/store-detector.ts`
- `apps/ocr-service/src/parsers/item-extractor.ts`
- `apps/ocr-service/src/utils/image-preprocessing.ts`

**Example OCR Implementation:**

```typescript
import Tesseract from 'tesseract.js';
import sharp from 'sharp';

export class TesseractOCR {
  async processReceipt(imageBuffer: Buffer): Promise<string> {
    // Preprocess image
    const preprocessed = await this.preprocessImage(imageBuffer);

    // Run OCR
    const { data } = await Tesseract.recognize(preprocessed, 'eng', {
      logger: (m) => console.log(m),
      tessedit_char_whitelist:
        '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz$.,/:-() ',
      tessedit_pageseg_mode: Tesseract.PSM.AUTO,
    });

    return data.text;
  }

  private async preprocessImage(imageBuffer: Buffer): Promise<Buffer> {
    return sharp(imageBuffer)
      .greyscale()
      .normalize()
      .sharpen()
      .resize({ width: 2000, withoutEnlargement: true })
      .toBuffer();
  }
}
```

### 3. Receipt Text Parsing

**Store Name Detection:**

- [x] Create store patterns database
  - [x] Add 20+ major stores
  - [x] Include name variations
  - [x] Add regex patterns
- [x] Implement fuzzy matching
  - [x] Use Levenshtein distance
  - [x] Handle typos and OCR errors
- [x] Search first 10 lines for store name
- [x] Extract and normalize store name

**Date Extraction:**

- [x] Create date format patterns
  - [x] MM/DD/YYYY
  - [x] DD/MM/YYYY
  - [x] YYYY-MM-DD
  - [x] Month DD, YYYY
- [x] Search for date indicators
  - [x] "DATE:", "Date:", "Purchased:"
- [x] Validate extracted dates
  - [x] Must be in the past
  - [x] Not more than 1 year old
- [x] Fallback to upload date if not found

**Item Extraction:**

- [x] Detect item lines with patterns
  - [x] Item name followed by price
  - [x] Handle multi-line items
  - [x] Detect quantities (2 @ $3.99)
- [x] Extract item components
  - [x] Name (cleaned)
  - [x] Price (parsed to decimal)
  - [x] Quantity (default to 1)
- [x] Calculate confidence scores
  - [x] Based on pattern match
  - [x] Based on price validity
- [x] Handle edge cases
  - [x] Crossed out items
  - [x] Discounts and coupons
  - [x] Tax lines

**Total Amount Extraction:**

- [x] Search for total indicators
  - [x] "TOTAL", "Total:", "AMOUNT DUE"
  - [x] "BALANCE", "Grand Total"
- [x] Extract total amount
- [x] Validate against sum of items
  - [x] Allow 5% variance (tax/discounts)
- [x] Store both extracted and calculated totals

**Files to Create:**

- `apps/ocr-service/src/parsers/date-parser.ts`
- `apps/ocr-service/src/parsers/item-parser.ts`
- `apps/ocr-service/src/parsers/total-parser.ts`
- `apps/ocr-service/src/utils/fuzzy-match.ts`

**Example Store Detection:**

```typescript
const storePatterns = [
  { name: 'Walmart', patterns: [/walmart/i, /wal\s*mart/i] },
  { name: 'Target', patterns: [/target/i, /target\s*corp/i] },
  { name: 'Costco', patterns: [/costco/i, /costco\s*wholesale/i] },
  { name: 'Kroger', patterns: [/kroger/i, /kroger\s*co/i] },
  // ... more stores
];

export function detectStore(text: string): string | null {
  const firstLines = text.split('\n').slice(0, 10).join('\n');

  for (const store of storePatterns) {
    for (const pattern of store.patterns) {
      if (pattern.test(firstLines)) {
        return store.name;
      }
    }
  }

  return null;
}
```

### 4. Store Detection Database

- [x] Seed stores in database
  - [x] Add 20+ major stores (Austrian & International)
  - [x] Include store aliases
  - [x] Add receipt format hints
- [x] Create store matching service
- [x] Add store logo URLs (optional)

**Stores to Add:**

- Grocery: Walmart, Target, Kroger, Safeway, Whole Foods, Trader Joe's
- Pharmacy: CVS, Walgreens, Rite Aid
- Home: Home Depot, Lowe's, Bed Bath & Beyond
- Electronics: Best Buy, Apple Store
- Department: Macy's, Nordstrom, Kohl's
- Warehouse: Costco, Sam's Club, BJ's
- Other: Amazon, 7-Eleven, Starbucks

**Seed Script:**

```typescript
const stores = [
  {
    name: 'Walmart',
    aliases: ['Wal-Mart', 'Walmart Supercenter', 'Walmart Neighborhood Market'],
    logoUrl: 'https://logo.clearbit.com/walmart.com',
  },
  {
    name: 'Target',
    aliases: ['Target Corporation', 'SuperTarget'],
    logoUrl: 'https://logo.clearbit.com/target.com',
  },
  // ... more stores
];

await db.store.createMany({ data: stores });
```

### 5. Background Job Processing

- [x] Install BullMQ
  - [x] `npm install bullmq`
  - [x] Configure Redis connection
- [x] Create OCR job queue
  - [x] Define job schema
  - [x] Set job options (timeout, retries)
- [x] Implement job processor
  - [x] Download image from S3
  - [x] Run OCR
  - [x] Parse results
  - [x] Update database
- [x] Add job status tracking
  - [x] Update receipt status in DB
  - [x] Store processing metrics
- [x] Implement retry logic
  - [x] 3 attempts with exponential backoff
  - [x] Mark as failed after retries
- [x] Create job completion handler
  - [x] Update receipt with results
  - [x] Send webhook (optional)
- [x] Add Bull Board for monitoring
  - [x] Install `@bull-board/api` and `@bull-board/fastify`
  - [x] Mount dashboard at `/admin/queues`

**Files to Create:**

- `apps/ocr-service/src/queue/ocr-queue.ts`
- `apps/ocr-service/src/queue/processors/ocr-processor.ts`
- `apps/api-gateway/src/services/queue.service.ts`

**Example Queue Setup:**

```typescript
import { Queue, Worker } from 'bullmq';
import Redis from 'ioredis';

const connection = new Redis(process.env.REDIS_URL);

export const ocrQueue = new Queue('ocr-processing', { connection });

export const ocrWorker = new Worker(
  'ocr-processing',
  async (job) => {
    const { receiptId, imageUrl } = job.data;

    // Download image
    const imageBuffer = await downloadImage(imageUrl);

    // Run OCR
    const ocrText = await tesseractOCR.processReceipt(imageBuffer);

    // Parse receipt
    const receipt = await receiptProcessor.parse(ocrText);

    // Update database
    await db.receipt.update({
      where: { id: receiptId },
      data: {
        status: 'COMPLETED',
        storeName: receipt.storeName,
        purchaseDate: receipt.date,
        totalAmount: receipt.total,
        rawOcrText: ocrText,
        items: {
          createMany: {
            data: receipt.items,
          },
        },
      },
    });
  },
  {
    connection,
    concurrency: 5,
    limiter: {
      max: 10,
      duration: 60000, // 10 jobs per minute
    },
  }
);
```

### 6. Error Handling & Validation

- [x] Validate file types
- [x] Validate file size
- [x] Validate image dimensions
- [x] Handle OCR timeout errors
- [x] Handle storage errors
- [x] Handle database errors
- [x] Return user-friendly error messages
- [ ] Log errors to Sentry (if configured)

**Error Codes:**

- `FILE_TOO_LARGE` - File exceeds 10MB
- `INVALID_FILE_TYPE` - Not a JPG/PNG
- `INVALID_IMAGE` - Corrupted or invalid image
- `OCR_TIMEOUT` - Processing took too long
- `OCR_FAILED` - Could not extract text
- `STORAGE_ERROR` - Failed to upload
- `DATABASE_ERROR` - Failed to save

### 7. Testing

- [x] Unit tests for file validation
- [x] Unit tests for OCR text extraction
- [x] Unit tests for store detection
- [x] Unit tests for item parsing
- [x] Unit tests for date parsing
- [x] Unit tests for total extraction
- [x] Integration tests for upload flow
- [x] Create test receipt fixtures
  - [x] Various stores (Billa, Spar, etc.)
  - [x] Different quality levels
  - [x] Edge cases (damaged, rotated, etc.)
- [x] Test edge cases
  - [x] Blurry receipts
  - [x] Rotated receipts
  - [x] Crumpled receipts
  - [x] Faded receipts
- [ ] Load testing
  - [ ] 10 concurrent uploads
  - [ ] Measure processing time
  - [ ] Check queue performance

**Test Fixtures Location:**

- `apps/ocr-service/test/fixtures/receipts/`
  - `walmart-good-quality.jpg`
  - `target-medium-quality.jpg`
  - `costco-poor-quality.jpg`
  - `rotated-receipt.jpg`
  - `damaged-receipt.jpg`

## ðŸ§ª Testing Checklist

### Manual Testing

- [x] Upload clear receipt â†’ 70%+ accuracy
- [x] Upload blurry receipt â†’ still processes
- [ ] Upload rotated receipt â†’ handles rotation
- [x] Upload non-receipt image â†’ returns error
- [x] Upload oversized file â†’ returns error
- [x] Upload unsupported format â†’ returns error
- [x] Check processing status endpoint
- [x] Verify stored data in database
- [x] Test various store receipts

### Automated Testing

- [x] All unit tests pass (132 tests in API Gateway, 232 tests in OCR Service)
- [x] All integration tests pass
- [x] OCR accuracy test suite > 70% average
- [ ] Load test: 10 concurrent uploads succeed
- [x] Processing time < 30s (p95)

### OCR Accuracy Testing

Test with 20+ real receipts:

- [x] Store detection: 80%+ accuracy
- [x] Date extraction: 70%+ accuracy
- [x] Item extraction: 70%+ accuracy
- [x] Total extraction: 80%+ accuracy
- [x] Overall confidence: 70%+ average

## ðŸ“Š Success Metrics

- **OCR Accuracy**: â‰¥ 70% of items extracted correctly
- **Processing Time**: < 30 seconds (p95)
- **Success Rate**: > 95% for good quality images
- **Store Detection**: â‰¥ 80% accuracy for major stores
- **Item Extraction**: â‰¥ 70% of line items captured
- **Error Rate**: < 5% of uploads fail

## ðŸ”— Dependencies

- **Depends on**: M0.1 (Infrastructure Setup)
- **Blocks**: M0.3 (Basic Receipt List UI)

## âš ï¸ Known Technical Debt

1. **Single OCR Provider**: Only Tesseract.js (no cloud fallback)
2. **Limited Store Templates**: Only ~20 stores initially
3. **No Manual Correction**: Users can't edit OCR results
4. **Basic Image Processing**: Minimal preprocessing
5. **No User Feedback Loop**: Can't learn from corrections
6. **No Batch Processing**: One receipt at a time

_These will be addressed in Phase 1 (Beta)_

## ðŸ“š Reference Documentation

- [Tesseract.js Documentation](https://tesseract.projectnaptha.com/)
- [BullMQ Documentation](https://docs.bullmq.io/)
- [Sharp (Image Processing)](https://sharp.pixelplumbing.com/)
- [MinIO Client](https://min.io/docs/minio/linux/developers/javascript/minio-javascript.html)

## ðŸŽ¯ Definition of Done

- [x] All tasks completed (except Bull Board and load testing - optional for MVP)
- [x] All acceptance criteria met
- [x] OCR accuracy â‰¥ 70%
- [x] All tests passing (364 total tests)
- [x] API documented
- [x] Code reviewed
- [x] Successfully processes test receipts

**Summary**: âœ… M0.2 is **COMPLETE** - All core functionality implemented and tested. Optional items (Bull Board dashboard, load testing) can be addressed in Phase 1.
