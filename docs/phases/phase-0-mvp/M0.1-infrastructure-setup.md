# M0.1: Infrastructure Setup

**Duration**: Week 1 (5-7 days)  
**Priority**: P0 (Critical)  
**Story Points**: 13

## 📋 User Story

**As a** developer  
**I want** a fully configured development environment with monorepo structure  
**So that** I can efficiently develop and test all services locally

## 🎯 Objectives

Set up the foundational infrastructure for the Pricy application including monorepo structure, database, API gateway, containerization, and CI/CD pipeline.

## ✅ Acceptance Criteria

- [ ] Monorepo structure created with Turborepo and pnpm workspaces
- [ ] PostgreSQL database configured with Prisma ORM
- [ ] Basic API Gateway running on Fastify
- [ ] Docker Compose orchestrates all services
- [ ] All services start successfully with `pnpm dev`
- [ ] Database migrations run without errors
- [ ] Basic health check endpoints respond correctly
- [ ] CI/CD pipeline executes successfully on GitHub Actions
- [ ] Development documentation is clear and complete

## 🏗️ Architecture

### Monorepo Structure

```
/
├── apps/
│   ├── web/                 # Next.js frontend
│   ├── api-gateway/         # Fastify API gateway
│   └── ocr-service/         # OCR processing service
├── packages/
│   ├── database/            # Prisma schema & client
│   ├── ui/                  # Shared UI components
│   ├── types/               # Shared TypeScript types
│   └── config/              # Shared configs (eslint, ts)
├── docker/                  # Docker configs
├── docs/                    # Documentation
├── turbo.json              # Turborepo config
├── pnpm-workspace.yaml     # pnpm workspaces
└── docker-compose.yml      # Local development
```

### Technology Stack

- **Package Manager**: pnpm v8+
- **Monorepo Tool**: Turborepo
- **Database**: PostgreSQL 15+
- **ORM**: Prisma 5+
- **API Framework**: Fastify v4+
- **Container**: Docker & Docker Compose
- **CI/CD**: GitHub Actions

## 📝 Tasks

### 1. Monorepo Setup

- [ ] Initialize Git repository
- [ ] Create `.gitignore` with common patterns
- [ ] Initialize pnpm workspace with `pnpm-workspace.yaml`
- [ ] Install and configure Turborepo
- [ ] Create `turbo.json` with pipeline configuration
- [ ] Set up workspace structure (apps/ and packages/)
- [ ] Configure TypeScript for monorepo
  - [ ] Root `tsconfig.json`
  - [ ] Base `tsconfig.base.json`
  - [ ] Workspace-specific configs
- [ ] Set up ESLint shared config
  - [ ] Create `packages/config/eslint`
  - [ ] Configure rules for TypeScript
  - [ ] Add import sorting
- [ ] Set up Prettier
  - [ ] Create `.prettierrc`
  - [ ] Configure formatting rules
  - [ ] Add `.prettierignore`
- [ ] Add root-level scripts
  - [ ] `pnpm dev` - Start all services
  - [ ] `pnpm build` - Build all apps
  - [ ] `pnpm lint` - Lint all code
  - [ ] `pnpm test` - Run all tests
  - [ ] `pnpm clean` - Clean build artifacts

**Files to Create:**

- `pnpm-workspace.yaml`
- `turbo.json`
- `tsconfig.json`
- `tsconfig.base.json`
- `.eslintrc.js`
- `.prettierrc`
- `package.json` (root)

### 2. Database Setup

- [ ] Create `packages/database` workspace
- [ ] Initialize Prisma in database package
- [ ] Configure PostgreSQL connection
- [ ] Define initial Prisma schema
  - [ ] User model (for future)
  - [ ] Receipt model
  - [ ] ReceiptItem model
  - [ ] Store model
  - [ ] Product model (for future)
- [ ] Set up Prisma Client generation
- [ ] Create initial migration
- [ ] Create seed data script
  - [ ] Seed 20+ major stores
  - [ ] Add store aliases
- [ ] Add database scripts
  - [ ] `db:migrate` - Run migrations
  - [ ] `db:seed` - Seed database
  - [ ] `db:studio` - Open Prisma Studio
  - [ ] `db:reset` - Reset database
- [ ] Configure connection pooling
- [ ] Document database schema

**Files to Create:**

- `packages/database/package.json`
- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/seed.ts`
- `packages/database/src/index.ts`

**Schema Example:**

```prisma
model Receipt {
  id              String        @id @default(uuid())
  userId          String?
  imageUrl        String
  storeName       String?
  purchaseDate    DateTime?
  totalAmount     Decimal?
  status          ReceiptStatus @default(PROCESSING)
  ocrProvider     String        @default("tesseract")
  ocrConfidence   Float?
  rawOcrText      String?
  processingTime  Int?
  items           ReceiptItem[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@index([purchaseDate])
}

enum ReceiptStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model ReceiptItem {
  id          String   @id @default(uuid())
  receiptId   String
  receipt     Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  name        String
  price       Decimal
  quantity    Int      @default(1)
  category    String?
  lineNumber  Int?
  confidence  Float?

  @@index([receiptId])
}

model Store {
  id            String   @id @default(uuid())
  name          String   @unique
  aliases       String[]
  logoUrl       String?
  receiptFormat String?
  createdAt     DateTime @default(now())
}
```

### 3. API Gateway Setup

- [ ] Create `apps/api-gateway` workspace
- [ ] Initialize Fastify application
- [ ] Configure TypeScript
- [ ] Set up environment variables with Zod validation
- [ ] Configure CORS
- [ ] Add security headers (Helmet)
- [ ] Set up request logging (Pino)
- [ ] Add health check endpoint
  - [ ] `GET /health` - Service health
  - [ ] `GET /health/db` - Database connectivity
- [ ] Add API versioning (`/api/v1`)
- [ ] Configure error handling middleware
- [ ] Add request validation with Zod
- [ ] Set up rate limiting
- [ ] Configure graceful shutdown
- [ ] Add request ID generation
- [ ] Document API structure

**Files to Create:**

- `apps/api-gateway/package.json`
- `apps/api-gateway/src/index.ts`
- `apps/api-gateway/src/app.ts`
- `apps/api-gateway/src/config/env.ts`
- `apps/api-gateway/src/routes/health.ts`
- `apps/api-gateway/src/plugins/error-handler.ts`

**Example Health Check:**

```typescript
import { FastifyInstance } from "fastify";
import { db } from "@pricy/database";

export async function healthRoutes(app: FastifyInstance) {
  app.get("/health", async () => {
    return { status: "ok", timestamp: new Date().toISOString() };
  });

  app.get("/health/db", async () => {
    try {
      await db.$queryRaw`SELECT 1`;
      return { status: "ok", database: "connected" };
    } catch (error) {
      return { status: "error", database: "disconnected", error };
    }
  });
}
```

### 4. Docker Configuration

- [ ] Create `docker/` directory for configs
- [ ] Create Dockerfile for API Gateway
  - [ ] Multi-stage build
  - [ ] Production-optimized
  - [ ] Non-root user
  - [ ] AGPL-3.0 license notice in image labels
- [ ] Create Dockerfile for OCR Service (placeholder)
- [ ] Create Dockerfile for Web/Frontend
  - [ ] Multi-stage build
  - [ ] Static asset optimization
  - [ ] Non-root user
- [ ] Create `docker-compose.yml` for local development
  - [ ] PostgreSQL service
  - [ ] Redis service
  - [ ] MinIO service (S3-compatible)
  - [ ] API Gateway service
  - [ ] OCR Service service
  - [ ] Web/Frontend service
- [ ] Create `docker-compose.prod.yml` for production
  - [ ] Production-ready configuration
  - [ ] External database support
  - [ ] Secrets management
  - [ ] Resource limits
  - [ ] Restart policies
- [ ] Configure service networking
- [ ] Add volume persistence for database
- [ ] Add health checks for all services
- [ ] Create `.dockerignore`
- [ ] Document Docker setup
- [ ] Add Docker deployment guide for self-hosting

**docker-compose.yml Services:**

```yaml
services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: pricy
      POSTGRES_PASSWORD: pricy
      POSTGRES_DB: pricy
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pricy"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  api-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.api-gateway
    environment:
      DATABASE_URL: postgresql://pricy:pricy@postgres:5432/pricy
      REDIS_URL: redis://redis:6379
      PORT: 3001
    ports:
      - "3001:3001"
    depends_on:
      - postgres
      - redis
```

### 5. CI/CD Pipeline

- [ ] Create `.github/workflows/ci.yml`
- [ ] Add linting job
  - [ ] Run ESLint on all workspaces
  - [ ] Check Prettier formatting
- [ ] Add type checking job
  - [ ] Run TypeScript compiler
  - [ ] Check all workspaces
- [ ] Add build job
  - [ ] Build all apps
  - [ ] Verify no build errors
- [ ] Add database migration check
  - [ ] Verify migrations can be generated
  - [ ] Check for migration conflicts
- [ ] Configure dependency caching
  - [ ] Cache pnpm store
  - [ ] Cache Turborepo cache
- [ ] Add matrix testing (optional for MVP)
- [ ] Configure branch protection rules
  - [ ] Require CI to pass
  - [ ] Require review for main branch
- [ ] Set up automated PR checks

**Example CI Workflow:**

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
```

### 6. Development Documentation

- [ ] Write comprehensive README.md
  - [ ] Project overview
  - [ ] AGPL-3.0 license badge and notice
  - [ ] Quick start guide
  - [ ] Prerequisites
  - [ ] Tech stack
- [ ] Create LICENSE file
  - [ ] Add AGPL-3.0 license text
  - [ ] Include copyright notice
- [ ] Create `docs/guides/getting-started.md`
  - [ ] Step-by-step setup
  - [ ] Common commands
  - [ ] Troubleshooting
- [ ] Create `docs/guides/self-hosting.md`
  - [ ] Docker deployment guide
  - [ ] Environment variables
  - [ ] Production setup recommendations
  - [ ] Backup and restore procedures
  - [ ] Scaling considerations
- [ ] Document environment variables
  - [ ] Create `.env.example`
  - [ ] Document each variable
  - [ ] Add validation rules
- [ ] Create architecture diagram
- [ ] Add contribution guidelines
  - [ ] Code style
  - [ ] Commit conventions
  - [ ] PR process
  - [ ] AGPL-3.0 compliance notes
- [ ] Document monorepo commands
  - [ ] Workspace operations
  - [ ] Building specific apps
  - [ ] Running tests
- [ ] Add troubleshooting guide
  - [ ] Common errors
  - [ ] Solutions
  - [ ] Where to get help

**Files to Create:**

- `README.md` (updated)
- `LICENSE` (AGPL-3.0)
- `docs/guides/getting-started.md`
- `docs/guides/self-hosting.md`
- `.env.example`
- `CONTRIBUTING.md`
- `docs/architecture.md` (update with implementation details)

## 🧪 Testing Checklist

### Local Development Tests

- [ ] Clone repository to fresh directory
- [ ] Run `pnpm install`
  - [ ] All dependencies install without errors
  - [ ] Takes less than 2 minutes
- [ ] Run `pnpm dev`
  - [ ] All services start
  - [ ] No errors in logs
  - [ ] Services ready within 30 seconds
- [ ] Test health checks
  - [ ] `curl http://localhost:3001/health` returns 200
  - [ ] `curl http://localhost:3001/health/db` returns 200
- [ ] Run `pnpm build`
  - [ ] All apps build successfully
  - [ ] No TypeScript errors
- [ ] Run `pnpm lint`
  - [ ] Linting passes
- [ ] Run database operations
  - [ ] `pnpm db:migrate` applies migrations
  - [ ] `pnpm db:seed` seeds data
  - [ ] `pnpm db:studio` opens Prisma Studio

### Docker Tests

- [ ] Run `docker-compose up`
  - [ ] All services start
  - [ ] Health checks pass
- [ ] Verify service connectivity
  - [ ] API can connect to PostgreSQL
  - [ ] API can connect to Redis
  - [ ] MinIO is accessible
- [ ] Test volume persistence
  - [ ] Stop and restart containers
  - [ ] Database data persists

### CI/CD Tests

- [ ] Push to feature branch
  - [ ] CI pipeline runs
  - [ ] All jobs pass
- [ ] Create pull request
  - [ ] Status checks appear
  - [ ] Branch protection enforced
- [ ] Test caching
  - [ ] Second run is faster
  - [ ] Dependencies cached

## 📊 Success Metrics

- **Setup Time**: < 10 minutes for new developer
- **Service Startup**: All services running in < 30 seconds
- **CI Pipeline**: Completes in < 5 minutes
- **Documentation**: New developer can start without help
- **Error Rate**: Zero critical errors in setup

## 🔗 Dependencies

None (foundational task)

## 📚 Reference Documentation

- [Turborepo Documentation](https://turbo.build/repo/docs)
- [pnpm Workspaces](https://pnpm.io/workspaces)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Fastify Documentation](https://www.fastify.io/docs/latest/)
- [Docker Compose](https://docs.docker.com/compose/)

## ⚠️ Important Notes

1. **Database Credentials**: Use strong passwords in production
2. **API Keys**: Never commit secrets to repository
3. **Port Conflicts**: Ensure ports are available before starting services
4. **Docker Resources**: Allocate sufficient memory/CPU to Docker
5. **Node Version**: Use Node.js 18+ for best compatibility

## 🎯 Definition of Done

- [ ] All tasks completed
- [ ] All acceptance criteria met
- [ ] All tests passing
- [ ] Documentation complete
- [ ] Code reviewed (if team)
- [ ] Deployed to development environment
- [ ] Team can run `pnpm dev` successfully
