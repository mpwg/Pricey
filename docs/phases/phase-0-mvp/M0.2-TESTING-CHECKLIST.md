# M0.2 Testing Checklist

Use this checklist to verify the M0.2 implementation is working correctly.

## Prerequisites

- [ ] Docker is running
- [ ] PostgreSQL is accessible on port 5432
- [ ] Redis is accessible on port 6379
- [ ] MinIO is accessible on port 9000
- [ ] Environment variables are configured (see `.env.example`)

## Setup Steps

```bash
# 1. Start infrastructure
pnpm docker:dev

# 2. Install dependencies
pnpm install

# 3. Run migrations
pnpm db:migrate

# 4. Seed database
pnpm db:seed

# 5. Verify database
pnpm db:studio
# Check that stores are seeded (should see 20+ stores)
```

## Service Startup

```bash
# Start all services in development mode
pnpm dev
```

This should start:

- [ ] API Gateway on http://localhost:3001
- [ ] OCR Service worker (background process)

Verify logs show:

- [ ] "Server listening at http://0.0.0.0:3001" (API Gateway)
- [ ] "OCR worker started" (OCR Service)

## API Testing

### 1. Health Check

```bash
curl http://localhost:3001/health
```

Expected response:

```json
{
  "status": "ok",
  "timestamp": "2025-10-25T...",
  "uptime": 123.45
}
```

- [ ] Health endpoint returns 200 OK

### 2. API Root

```bash
curl http://localhost:3001/api/v1
```

Expected response:

```json
{
  "success": true,
  "data": {
    "message": "Pricey API v1",
    "version": "0.1.0",
    "documentation": "/api/v1/docs"
  }
}
```

- [ ] API root returns version info

### 3. Upload Receipt (Valid)

Create a test receipt image or download one, then:

```bash
curl -X POST http://localhost:3001/api/v1/receipts/upload \
  -F "file=@/path/to/receipt.jpg"
```

Expected response (201 Created):

```json
{
  "id": "uuid",
  "status": "processing",
  "uploadedAt": "2025-10-25T...",
  "processingStartedAt": "2025-10-25T...",
  "imageUrl": "http://localhost:9000/pricey-receipts/receipts/2025-10-25/uuid.jpg"
}
```

- [ ] Upload returns 201 Created
- [ ] Response includes receipt ID
- [ ] Status is "processing"
- [ ] Image URL is returned

### 4. Check Receipt Status

```bash
# Replace {id} with the receipt ID from step 3
curl http://localhost:3001/api/v1/receipts/{id}/status
```

Initial response (while processing):

```json
{
  "id": "uuid",
  "status": "processing",
  "progress": 50
}
```

After completion:

```json
{
  "id": "uuid",
  "status": "completed",
  "progress": 100,
  "ocrResult": {
    "storeName": "Store Name",
    "date": "2025-10-25T00:00:00Z",
    "items": [
      {
        "name": "Item 1",
        "price": 3.99,
        "quantity": 1,
        "confidence": 0.85
      }
    ],
    "total": 45.67
  },
  "processingTime": 12500
}
```

- [ ] Status endpoint returns 200 OK
- [ ] Status changes from "processing" to "completed"
- [ ] OCR results are included when completed
- [ ] Items are extracted
- [ ] Processing time is recorded

### 5. Get Full Receipt Details

```bash
curl http://localhost:3001/api/v1/receipts/{id}
```

Expected response:

```json
{
  "id": "uuid",
  "imageUrl": "http://localhost:9000/...",
  "storeName": "Store Name",
  "purchaseDate": "2025-10-25T00:00:00Z",
  "totalAmount": 45.67,
  "status": "completed",
  "ocrProvider": "tesseract",
  "ocrConfidence": 0.85,
  "rawOcrText": "Full OCR text...",
  "processingTime": 12500,
  "items": [
    {
      "id": "uuid",
      "name": "Item 1",
      "price": 3.99,
      "quantity": 1,
      "category": null,
      "lineNumber": 0,
      "confidence": 0.85
    }
  ],
  "createdAt": "2025-10-25T...",
  "updatedAt": "2025-10-25T..."
}
```

- [ ] Details endpoint returns 200 OK
- [ ] All receipt fields are present
- [ ] Items array is populated
- [ ] Raw OCR text is stored

## Error Handling Tests

### 1. Upload Invalid File Type

```bash
curl -X POST http://localhost:3001/api/v1/receipts/upload \
  -F "file=@/path/to/document.pdf"
```

Expected response (400 Bad Request):

```json
{
  "error": "Invalid file type. Allowed types: image/jpeg, image/jpg, image/png",
  "code": "INVALID_FILE_TYPE"
}
```

- [ ] Returns 400 for invalid file type

### 2. Upload Oversized File

Create a file larger than 10MB and upload:

```bash
# Create 11MB test file
dd if=/dev/zero of=large.jpg bs=1M count=11

curl -X POST http://localhost:3001/api/v1/receipts/upload \
  -F "file=@large.jpg"
```

Expected response (400 Bad Request):

```json
{
  "error": "File size exceeds maximum of 10MB",
  "code": "FILE_TOO_LARGE"
}
```

- [ ] Returns 400 for oversized file

### 3. Upload Without File

```bash
curl -X POST http://localhost:3001/api/v1/receipts/upload
```

Expected response (400 Bad Request):

```json
{
  "error": "No file provided",
  "code": "NO_FILE"
}
```

- [ ] Returns 400 when no file provided

### 4. Get Non-Existent Receipt

```bash
curl http://localhost:3001/api/v1/receipts/00000000-0000-0000-0000-000000000000
```

Expected response (404 Not Found):

```json
{
  "error": "Receipt not found",
  "code": "NOT_FOUND"
}
```

- [ ] Returns 404 for non-existent receipt

## Database Verification

Open Prisma Studio:

```bash
pnpm db:studio
```

Navigate to http://localhost:5555 and verify:

- [ ] `Store` table has 20+ stores
- [ ] `Receipt` table has uploaded receipts
- [ ] `ReceiptItem` table has extracted items
- [ ] Receipt status is "COMPLETED" or "FAILED"
- [ ] Items have proper relationships to receipts

## Storage Verification

Open MinIO Console at http://localhost:9001

Login with:

- Username: `minioadmin`
- Password: `minioadmin`

Verify:

- [ ] `pricey-receipts` bucket exists
- [ ] Uploaded images are stored in `receipts/YYYY-MM-DD/` folders
- [ ] Images are accessible via URL

## Redis Queue Verification

Connect to Redis:

```bash
docker exec -it pricey-redis redis-cli
```

Check queue status:

```redis
# List all keys
KEYS *

# Check queue length
LLEN bull:ocr-processing:wait

# Check completed jobs
LLEN bull:ocr-processing:completed
```

- [ ] Queue keys exist in Redis
- [ ] Jobs are being processed (wait queue should be empty after processing)
- [ ] Completed jobs are tracked

## Performance Testing

### Processing Time

Upload 5 receipts and measure processing time:

```bash
for i in {1..5}; do
  time curl -X POST http://localhost:3001/api/v1/receipts/upload \
    -F "file=@receipt.jpg"
done
```

- [ ] All uploads complete successfully
- [ ] Processing time < 30 seconds per receipt
- [ ] No timeouts or errors

### Concurrent Uploads

Upload multiple receipts simultaneously:

```bash
for i in {1..5}; do
  curl -X POST http://localhost:3001/api/v1/receipts/upload \
    -F "file=@receipt.jpg" &
done
wait
```

- [ ] All concurrent uploads succeed
- [ ] No race conditions or errors
- [ ] Queue handles concurrency properly

## OCR Accuracy Testing

Test with various receipt types:

1. **Clear, high-quality receipt**:
   - [ ] Store name detected correctly
   - [ ] Date extracted correctly
   - [ ] 70%+ of items extracted
   - [ ] Total amount extracted

2. **Low-quality receipt**:
   - [ ] Processing completes (doesn't crash)
   - [ ] At least partial extraction
   - [ ] Status set to COMPLETED

3. **Rotated receipt**:
   - [ ] Processing completes
   - [ ] Some text extracted

4. **Receipt from different store**:
   - [ ] Store detection attempts made
   - [ ] Items extracted even if store unknown

## Logging Verification

Check logs for proper output:

API Gateway logs should show:

- [ ] Request logging with request IDs
- [ ] Upload events
- [ ] Queue job creation
- [ ] Response status codes

OCR Service logs should show:

- [ ] Worker startup
- [ ] Job processing start
- [ ] Image download
- [ ] OCR processing
- [ ] Database updates
- [ ] Job completion

## Cleanup

After testing:

```bash
# Stop services
Ctrl+C (in terminal running pnpm dev)

# Stop infrastructure
pnpm docker:dev:down

# Optional: Clean build artifacts
pnpm clean
```

## Success Criteria

All checkboxes should be marked. If any fail:

1. Check logs for errors
2. Verify environment variables
3. Ensure all services are running
4. Check database migrations are applied
5. Verify MinIO/S3 is accessible
6. Confirm Redis is running

## Known Issues

- First OCR job may be slower (Tesseract initialization)
- Very blurry receipts may not extract accurately (expected, <70% accuracy)
- Store detection limited to seeded stores
- No manual correction UI (Phase 0 limitation)

## Next Steps

Once all tests pass:

1. Document any issues found
2. Fine-tune OCR parameters if needed
3. Add more store patterns based on testing
4. Proceed to M0.3: Basic Receipt List UI
